<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — BrightBash</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="max-container admin">
    <div class="site-inner">
      <h1>Bookings Admin</h1>
      <p>View, export, or delete bookings. This page will use the server if available, otherwise it reads localStorage.</p>

      <div id="controls">
      <label style="display:inline-flex;align-items:center;gap:.5rem"><input id="admin-token" type="password" placeholder="admin token" style="padding:.25rem"> <button id="save-token">Set</button></label>
      <button id="refresh">Refresh</button>
      <button id="export">Export JSON</button>
    </div>

      <div id="bookings"></div>
    </div>
  </main>

<script>
// admin client: uses server if available at http://localhost:4000 or window.BOOKINGS_API
const API = window.BOOKINGS_API || 'http://localhost:4000';
let apiAvailable = false;
let adminToken = sessionStorage.getItem('brightbash_admin_token') || '';

function authHeaders(){ return adminToken ? { 'Authorization': 'Bearer ' + adminToken, 'Content-Type':'application/json' } : {'Content-Type':'application/json'} }

async function probe(){
  try{ const r = await fetch(API + '/ping'); apiAvailable = r.ok; }catch(e){ apiAvailable=false }
}

function renderLocal(obj){
  const container = document.getElementById('bookings'); container.innerHTML='';
  const keys = Object.keys(obj).sort();
  if(!keys.length) { container.textContent = 'No bookings found.'; return; }
  keys.forEach(date=>{
    const h = document.createElement('h3'); h.textContent = date; container.appendChild(h);
    const list = document.createElement('div'); list.className='admin-list';
    (obj[date]||[]).forEach(b=>{
      const row = document.createElement('div'); row.className='admin-row';
      row.innerHTML = `<div class="when">${b.timeslot.from}–${b.timeslot.to}</div><div class="who">${b.organizer} &lt;${b.contact}&gt;</div><div class="meta">${b.package} • ${b.kids} kids</div>`;
      const edit = document.createElement('button'); edit.textContent='Edit'; edit.className='muted';
      edit.addEventListener('click', ()=>editBooking(date,b));
      const del = document.createElement('button'); del.textContent='Delete'; del.className='danger';
      del.addEventListener('click', ()=>deleteBooking(date,b.timeslot.from,b.timeslot.to));
      row.appendChild(edit);
      row.appendChild(del);
      list.appendChild(row);
    });
    container.appendChild(list);
  });
}

async function load(){
  await probe();
  if(apiAvailable){
    try{ const r = await fetch(API + '/bookings', {headers: authHeaders()}); if(r.ok){ const data = await r.json(); renderLocal(data); return; }}catch(e){}
  }
  // fallback to localStorage
  const raw = localStorage.getItem('BRIGHTBASH_BOOKINGS_V1');
  const obj = raw?JSON.parse(raw):{};
  renderLocal(obj);
}

async function deleteBooking(date,from,to){
  if(!confirm('Delete booking on ' + date + ' ' + from + '–' + to + '?')) return;
  if(apiAvailable){
    try{ const r = await fetch(API + '/bookings',{method:'DELETE',headers: authHeaders(),body:JSON.stringify({date,from,to})}); if(r.ok){ await load(); return; }}catch(e){}
  }
  // fallback: localStorage
  const raw = localStorage.getItem('BRIGHTBASH_BOOKINGS_V1'); const obj = raw?JSON.parse(raw):{};
  if(obj[date]) obj[date] = obj[date].filter(b=> !(b.timeslot.from===from && b.timeslot.to===to));
  localStorage.setItem('BRIGHTBASH_BOOKINGS_V1', JSON.stringify(obj));
  await load();
}

document.getElementById('refresh').addEventListener('click', load);
document.getElementById('export').addEventListener('click', ()=>{
  (async ()=>{
    if(apiAvailable){
      try{ const r = await fetch(API + '/bookings', {headers: authHeaders()}); if(r.ok){ const data = await r.json(); const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'bookings.json'; a.click(); URL.revokeObjectURL(url); return; }}catch(e){}
    }
    const raw = localStorage.getItem('BRIGHTBASH_BOOKINGS_V1') || '{}';
    const blob = new Blob([raw],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'bookings.json'; a.click(); URL.revokeObjectURL(url);
  })();
});

document.getElementById('save-token').addEventListener('click', ()=>{ const t = document.getElementById('admin-token').value.trim(); adminToken = t; sessionStorage.setItem('brightbash_admin_token', adminToken); alert('Admin token saved to session. Use Refresh to re-load.'); });

async function editBooking(date, booking){
  const organizer = prompt('Organizer name', booking.organizer||'') || booking.organizer;
  const contact = prompt('Contact', booking.contact||'') || booking.contact;
  const kids = prompt('Number of kids', booking.kids||'') || booking.kids;
  const pkg = prompt('Package', booking.package||'starter') || booking.package;
  const from = prompt('From time (HH:MM)', booking.timeslot.from) || booking.timeslot.from;
  const to = prompt('To time (HH:MM)', booking.timeslot.to) || booking.timeslot.to;
  if(apiAvailable){
    try{
      await fetch(API + '/bookings', {method:'DELETE', headers: authHeaders(), body: JSON.stringify({date, from: booking.timeslot.from, to: booking.timeslot.to})});
      await fetch(API + '/bookings', {method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({date, organizer, contact, kids, package: pkg, timeslot:{from,to}})});
      await load(); return;
    }catch(e){ console.error(e); }
  }
  const raw = localStorage.getItem('BRIGHTBASH_BOOKINGS_V1') || '{}'; const obj = JSON.parse(raw);
  if(!obj[date]) obj[date]=[];
  obj[date] = obj[date].filter(b=> !(b.timeslot.from===booking.timeslot.from && b.timeslot.to===booking.timeslot.to));
  obj[date].push({organizer, contact, kids, package: pkg, timeslot:{from,to}, created: Date.now()});
  localStorage.setItem('BRIGHTBASH_BOOKINGS_V1', JSON.stringify(obj));
  await load();
}

load();
</script>
</body>
</html>